apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Base resources
resources:
  - ../../common
  - ../../mysql
  - ../../users
  - ../../products
  - ../../orders
  - ../../frontend

# Namespace
namespace: microstore

# Common labels para todos los recursos
commonLabels:
  environment: azure-aks
  managed-by: kustomize
  cloud-provider: azure

# Patches específicos para Azure AKS
patches:
  # Asegurar imagePullPolicy Always para ACR
  - target:
      kind: Deployment
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: Always
  
  # Las imágenes se actualizarán con el script usando ACR_LOGIN_SERVER
  # Por ahora mantener placeholder que el script reemplazará

# ConfigMap patches para Azure
configMapGenerator:
  - name: app-config
    behavior: merge
    literals:
      - CONTAINER_REGISTRY=ACR_PLACEHOLDER  # Se actualizará con script
      - EXTERNAL_IP=AZURE_IP_PLACEHOLDER    # Se actualizará con script

# Ajustes de recursos para Azure (más generosos)
replicas:
  - name: users-deployment
    count: 2
  - name: products-deployment
    count: 2
  - name: orders-deployment
    count: 2
  - name: frontend-deployment
    count: 2
