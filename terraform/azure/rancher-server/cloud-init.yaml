#cloud-config

# InstalaciÃ³n automÃ¡tica de Docker y Rancher v2.8.3
# Compatible con Ubuntu 22.04 LTS

package_update: true
package_upgrade: true

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - net-tools
  - software-properties-common
  - unzip
  - vim

runcmd:
  # Instalar Docker
  - curl -fsSL https://get.docker.com -o /tmp/get-docker.sh
  - sh /tmp/get-docker.sh
  - usermod -aG docker azureuser
  - systemctl enable docker
  - systemctl start docker

  # Crear directorio persistente para Rancher
  - mkdir -p /opt/rancher
  - chmod 755 /opt/rancher

  # Desplegar Rancher ${rancher_version}
  - |
    docker run --privileged -d --restart=unless-stopped \
      --name rancher \
      -p 80:80 -p 443:443 \
      -v /opt/rancher:/var/lib/rancher \
      rancher/rancher:${rancher_version}

  # Esperar a que Rancher estÃ© saludable
  - |
    for i in {1..60}; do
      if [ "$(docker inspect -f '{{.State.Health.Status}}' rancher 2>/dev/null || echo 'starting')" == "healthy" ]; then
        echo "Rancher is healthy!" > /tmp/rancher-status.txt
        break
      fi
      echo "Waiting for Rancher to be healthy... ($i/60)" >> /tmp/rancher-init.log
      sleep 10
    done

  # Guardar bootstrap password
  - docker logs rancher 2>&1 | grep "Bootstrap Password:" > /tmp/rancher-bootstrap-password.txt || true

  # Instalar kubectl (opcional pero Ãºtil)
  - curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
  - install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
  - rm kubectl

write_files:
  - path: /etc/motd
    content: |
      ============================================
      ðŸš€ Rancher Server ${rancher_version}
      ============================================
      
      Rancher UI: https://<THIS_VM_IP>
      
      Get bootstrap password:
        sudo docker logs rancher 2>&1 | grep "Bootstrap Password:"
      
      Check Rancher status:
        sudo docker ps
        sudo docker logs -f rancher
      
      SSH Key: Use the key generated by Terraform
      ============================================

final_message: "Rancher installation completed after $UPTIME seconds"
